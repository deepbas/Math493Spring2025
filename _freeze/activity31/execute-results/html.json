{
  "hash": "6ec09b92eadf3f7ed97f880830eb031c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Activity31\"\nformat: \n  live-html:\n    theme:\n      light: [lux, theme-light.scss]\n      dark: [superhero, theme-dark.scss] \nengine: knitr\ntoc: true\n---\n\n::: {.cell}\n\n:::\n\n\n\n::: {.cell}\n\n:::\n\nToday, we’ll review the structure of ETS models, derive the forecasting equations, and then explore specific variants including ETS(M,N,A), ETS(M,A,A), ETS(A,Ad,A), and ETS(A,A,M). \n\nLast class, we calculated the equations,\n\n$$\n\\begin{align}\ny_t &= (\\ell_{t-1}+s_{t-m})(1+\\varepsilon_t),\\\\[1mm]\n\\ell_t &= \\ell_{t-1}+\\alpha\\,(\\ell_{t-1}+s_{t-m})\\,\\varepsilon_t,\\\\[1mm]\ns_t &= s_{t-m}+\\gamma\\,(\\ell_{t-1}+s_{t-m})\\,\\varepsilon_t,\n\\end{align}\n$$\n\nfor the ETS(M,N,A) case and\n\n$$\n\\begin{align}\ny_t &= (\\ell_{t-1}+b_{t-1}+s_{t-m})(1+\\varepsilon_t),\\\\[1mm]\n\\ell_t &= \\ell_{t-1}+b_{t-1}+\\alpha\\,(\\ell_{t-1}+b_{t-1}+s_{t-m})\\,\\varepsilon_t,\\\\[1mm]\nb_t &= b_{t-1}+\\beta\\,(\\ell_{t-1}+b_{t-1}+s_{t-m})\\,\\varepsilon_t,\\\\[1mm]\ns_t &= s_{t-m}+\\gamma\\,(\\ell_{t-1}+b_{t-1}+s_{t-m})\\,\\varepsilon_t,\n\\end{align}\n$$\n\nfor the ETS(M,A,A) case.\n\n### Derivation Outline\n\n1. **Observation Equation & Error Definition**\n\n   The model starts with\n\n   $$\n   y_t = \\mu_t\\,(1+\\varepsilon_t)\n   $$\n   \n   where the forecast is \n   \n$$\\mu_t = \\ell_{t-1}+s_{t-m}\\quad \\text{(or } \\ell_{t-1}+b_{t-1}+s_{t-m}\\quad\\text{for ETS(M,A,A))},$$\n   \n   so that\n\n   $$\n   \\varepsilon_t = \\frac{y_t}{\\mu_t}-1.\n   $$\n\n2. **State Updates**\n\n   In a multiplicative-error model the updates use the forecast scale:\n\n   - **Level update:**\n     \n     $$\n     \\ell_t = \\ell_{t-1}+\\alpha\\,\\mu_t\\,\\varepsilon_t.\n     $$\n     \n   - **Seasonal update (no trend version):**\n     \n     $$\n     s_t = s_{t-m}+\\gamma\\,\\mu_t\\,\\varepsilon_t.\n     $$\n     \n   - **For the ETS(M,A,A) model**, the trend (or slope) is updated similarly:\n     \n     $$\n     b_t = b_{t-1}+\\beta\\,\\mu_t\\,\\varepsilon_t.\n     $$\n\n3. **Verification by Recursion**\n\n   Suppose the state at time $t-1$ is known. Then:\n   \n   - The forecast is $\\mu_t = \\ell_{t-1}+s_{t-m}$ (or $\\ell_{t-1}+b_{t-1}+s_{t-m}$).\n   - The error is computed as \n     \n     $$\n     \\varepsilon_t = \\frac{y_t}{\\mu_t}-1,\n     $$\n     \n     so that by substitution\n   \n     $$\n     y_t-\\mu_t=\\mu_t\\,\\varepsilon_t.\n     $$\n     \n   - Therefore, the level update becomes\n     \n     $$\n     \\ell_t = \\ell_{t-1}+\\alpha\\,(y_t-\\mu_t),\n     $$\n     \n     and similarly for the seasonal and trend updates. This recursive structure ensures that any deviation of the observation from the forecast is proportionally fed back into the states—*scaled* by the forecast level. \n\n\n## 1. Recursive Updating Equations Summary\n\n- **Step 1:** Compute the forecast $\\mu_t$ based on current state components.\n- **Step 2:** Calculate the error $\\varepsilon_t$ (multiplicative or additive).\n- **Step 3:** Update state components (level, trend, seasonal) using the error and smoothing parameters.\n- **Step 4:** Repeat for each new observation.\n\n\n## 2. Deriving the ETS(M,N,A) Model\n\n### 2.1 Model Structure\n\nFor ETS(M,N,A) (multiplicative error, no trend, additive seasonality), the equations are:\n\n$$\n\\begin{align}\ny_t &= (\\ell_{t-1}+s_{t-m})(1+\\varepsilon_t),\\\\[1mm]\n\\ell_t &= \\ell_{t-1}+\\alpha\\,(\\ell_{t-1}+s_{t-m})\\,\\varepsilon_t,\\\\[1mm]\ns_t &= s_{t-m}+\\gamma\\,(\\ell_{t-1}+s_{t-m})\\,\\varepsilon_t,\n\\end{align}\n$$\n\nwhere:\n\n- $y_t$ is the observed value at time $t$.\n- $\\ell_{t-1}$ is the level component.\n- $s_{t-m}$ is the seasonal component (with period $m$).\n- $\\varepsilon_t$ is the multiplicative error, defined as \n  $$\n  \\varepsilon_t = \\frac{y_t}{\\ell_{t-1}+s_{t-m}}-1.\n  $$\n- $\\alpha$ and $\\gamma$ are the smoothing parameters.\n\n### 2.2 Interpretation\n\n- **Observation Equation:** The forecast is given by the sum of the level and seasonal component, scaled by the multiplicative error.\n- **Level Update:** The level is adjusted by the error scaled by the current forecast.\n- **Seasonal Update:** The seasonal component is updated similarly, ensuring seasonal effects propagate correctly.\n\n\n## 3. ETS(M,A,A) Model\n\n### 3.1 Model Structure\n\nFor ETS(M,A,A) (multiplicative error, additive trend, additive seasonality), an additional trend component $b_{t-1}$ is introduced:\n\n$$\n\\begin{align}\ny_t &= (\\ell_{t-1}+b_{t-1}+s_{t-m})(1+\\varepsilon_t),\\\\[1mm]\n\\ell_t &= \\ell_{t-1}+b_{t-1}+\\alpha\\,(\\ell_{t-1}+b_{t-1}+s_{t-m})\\,\\varepsilon_t,\\\\[1mm]\nb_t &= b_{t-1}+\\beta\\,(\\ell_{t-1}+b_{t-1}+s_{t-m})\\,\\varepsilon_t,\\\\[1mm]\ns_t &= s_{t-m}+\\gamma\\,(\\ell_{t-1}+b_{t-1}+s_{t-m})\\,\\varepsilon_t.\n\\end{align}\n$$\n\n### 3.2 Interpretation\n\n- **Trend Component:** The term $b_{t-1}$ represents the additive trend.\n- **Trend Update:** The trend is adjusted with its own smoothing parameter $\\beta$.\n- The observation and seasonal equations are similar to ETS(M,N,A) but include the trend in the forecast.\n\n\n## 4. Exploring Other Combinations\n\n### 4.1 ETS(A,Ad,A) Model\n\nThe ETS(A,Ad,A) model uses an **additive error**, an **additive damped trend**, and **additive seasonality**. Its equations can be written as:\n\n$$\n\\begin{align}\ny_t &= \\ell_{t-1}+ \\phi d_{t-1}+ s_{t-m}+\\varepsilon_t,\\\\[1mm]\n\\ell_t &= \\ell_{t-1} + \\phi d_{t-1} + \\alpha \\varepsilon_t, \\\\\nd_t &= \\phi d_{t-1} + \\beta \\varepsilon_t, \\\\\ns_t &= s_{t-m} + \\gamma \\varepsilon_t,\n\\end{align}\n$$\n\nwhere:\n\n- $\\varepsilon_t$ is an additive error.\n- $d_{t-1}$ represents the trend component.\n- $\\phi$ is the damping parameter, $0 < \\phi < 1$, that reduces the trend effect over time.\n\n### 4.2 ETS(A,A,M) Model\n\nFor the ETS(A,A,M) model, the seasonal component enters multiplicatively while both the error and trend are additive:\n\n$$\n\\begin{align}\ny_t &= (\\ell_{t-1}+b_{t-1}+s_{t-m})(1+\\varepsilon_t),\\\\[1mm]\n\\ell_t &= \\ell_{t-1}+b_{t-1}+\\alpha\\,\\varepsilon_t,\\\\[1mm]\nb_t &= b_{t-1}+\\beta\\,\\varepsilon_t,\\\\[1mm]\ns_t &= s_{t-m}\\,(1+\\gamma\\,\\varepsilon_t).\n\\end{align}\n$$\n\n### 4.3 Key Points in Model Variations\n\n- **Error Type:** Whether the error is additive or multiplicative will affect how deviations are incorporated into the state updates.\n- **Trend Component:** The presence (or absence) of a trend (additive or damped) changes the update equations. In a damped trend, the damping parameter $\\phi$ moderates the trend's influence.\n- **Seasonal Component:** Additive seasonality adds or subtracts a fixed amount, while multiplicative seasonality scales the forecast.\n\n\n## 5. Fitting ETS Models with Tidyverts\n\nThe **Tidyverts** framework in R (which includes packages such as `fable` and `tsibble`) provides a streamlined approach to fitting ETS models. Below is an example workflow.\n\n### **Sunspot Activity Dataset (1749-2023)**  \n\n\n::: {.cell}\n```{webr}\n# Convert classic ts object to tsibble\nsunspots <- as_tsibble(sunspot.month) %>%\n  rename(spots = value, year_month = index) \n\nsunspots %>% autoplot(spots) +\n  labs(title = \"Monthly Sunspot Numbers Since 1749\",\n       subtitle = \"11-year solar cycles visible\",\n       y = \"Sunspot Count\")\n```\n:::\n\n\n### ETS Analysis Code\n\n::: {.cell}\n```{webr}\n# Fit models accounting for long cycles\nsun_fits <- sunspots %>%\n  model(\n    ETS_MNA = ETS(spots ~ error(\"M\") + trend(\"N\") + season(\"A\")),\n    ETS_MAA = ETS(spots ~ error(\"M\") + trend(\"A\") + season(\"A\")),\n    ETS_AAdA = ETS(spots ~ error(\"A\") + trend(\"Ad\") + season(\"A\")),\n    ETS_AAM = ETS(spots ~ error(\"A\") + trend(\"A\") + season(\"M\")),\n    ETS_auto = ETS(spots)\n  )\n\n# Compare performance \nglance(sun_fits) %>% arrange(AICc)\n\nsun_fits %>% dplyr::select(ETS_MNA) %>% report() #ETS_MNA\nsun_fits %>% dplyr::select(ETS_MAA) %>% report() #ETS_MAA\nsun_fits %>% dplyr::select(ETS_AAdA) %>% report() #ETS_AAdA\nsun_fits %>% dplyr::select(ETS_AAM) %>% report() #ETS_AAM\nsun_fits %>% dplyr::select(ETS_auto) %>% report() #ETS_AAM\n```\n:::\n\n\n### Diagnostics & Forecasting\n\n::: {.cell}\n```{webr}\n# Residual analysis for best model\nsun_fits %>% dplyr::select(ETS_AAdA) %>% gg_tsresiduals()\n\n# 15-year forecast showing damped trend\nsun_fits %>% dplyr::select(ETS_AAdA) %>%\n  forecast(h = 10) %>%  \n  autoplot(sunspots %>% tail(n=50)) +\n  labs(title = \"Sunspot Activity Forecast with Damped Trend\")\n```\n:::\n\n\n",
    "supporting": [
      "activity31_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}