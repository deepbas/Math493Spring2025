{
  "hash": "477cfd84a56fc1857a6727922e514fa2",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Activity14\"\nformat: live-html\nengine: knitr\ntoc: true\nwebr:\n  packages:\n    - dplyr\n    - ggplot2\n    - fpp3\n    - patchwork\n    - tsibbledata\n    - urca\n    - astsa\n    - COVID19\nwarning: false\nmessage: false\n---\n\n::: {.cell}\n\n:::\n\n\n::: {.cell}\n\n:::\n\n\n## Regression with Lagged Variables & Multivariate EDA\n\n### Objective\n\nImprove seasonal forecasting models using:  \n\n1. **Autoregressive components** via lagged variables ($y_{t-1}, y_{t-2}$)  \n2. **Multivariate diagnostics** using correlation matrices and pairwise plots\n\n- **Lagged variables** capture serial dependence: $E[y_t | y_{t-1}]$  \n- **Fourier terms** model periodic patterns: $S_t = \\sum_{k=1}^K [\\alpha_k\\sin(2\\pi kt/m) + \\beta_k\\cos(2\\pi kt/m)]$  \n- **Multicollinearity** detection via pairwise correlations (|r| > 0.8 indicates potential issues)\n\n### Focus\n\n- Extend the NYSE example by including lagged volume values.\n- Visualize relationships between the current volume, its lagged values, and Fourier terms.\n\n### Step-by-Step Tutorial\n\n#### 1. Data Preparation & Lag Creation\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get NYSE Composite index data (volume) from tidyquant and convert to tsibble\nnyse <- tq_get(\"^NYA\", from = \"2021-01-01\", to = Sys.Date(), get = \"stock.prices\") %>% \n  as_tsibble(index = date) %>% \n  fill_gaps() %>% \n  mutate(volume = na.approx(volume),\n         adjusted = na.approx(adjusted),\n         logVolume = log(volume)) %>% \n  select(date, volume, logVolume, adjusted)\n\n# Plot volume series\nnyse %>% \n  autoplot(volume) +\n  labs(title = \"NYSE Composite Index Volume\", y = \"Volume\", x = \"Date\")\n```\n\n::: {.cell-output-display}\n![](activity14_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Create extended lag structure (4 weeks backward)\nnyse <- nyse %>% \n  mutate(volume_lag1 = lag(volume, 1),\n         volume_lag2 = lag(volume, 2)) %>% \n  drop_na()\n```\n:::\n\n#### 2. Regression with Lagged Variables & Fourier Terms\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit a model including Fourier terms and lagged volume predictors\nnyse_lag_model <- nyse %>% \n  model(\n    LagModel = TSLM(volume ~ fourier(K = 2) + volume_lag1 + volume_lag2)\n  )\n\nreport(nyse_lag_model) %>% \nglance(nyse_lag_model) %>% knitr::kable()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSeries: volume \nModel: TSLM \n\nResiduals:\n       Min         1Q     Median         3Q        Max \n-2.021e+09 -2.263e+08 -4.514e+07  1.531e+08  4.212e+09 \n\nCoefficients:\n                     Estimate Std. Error t value Pr(>|t|)    \n(Intercept)         8.903e+08  7.238e+07  12.299  < 2e-16 ***\nfourier(K = 2)C1_7  8.243e+07  2.018e+07   4.085 4.63e-05 ***\nfourier(K = 2)S1_7  4.642e+06  2.018e+07   0.230   0.8181    \nfourier(K = 2)C2_7 -3.600e+07  2.013e+07  -1.788   0.0740 .  \nfourier(K = 2)S2_7  4.669e+07  2.012e+07   2.321   0.0204 *  \nvolume_lag1         7.810e-01  2.563e-02  30.472  < 2e-16 ***\nvolume_lag2         1.016e-02  2.563e-02   0.397   0.6918    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 555600000 on 1522 degrees of freedom\nMultiple R-squared: 0.6253,\tAdjusted R-squared: 0.6239\nF-statistic: 423.4 on 6 and 1522 DF, p-value: < 2.22e-16\n```\n\n\n:::\n\n::: {.cell-output-display}\n\n\n|.model   | r_squared| adj_r_squared|       sigma2| statistic| p_value| df|   log_lik|      AIC|     AICc|      BIC|           CV|     deviance| df.residual| rank|\n|:--------|---------:|-------------:|------------:|---------:|-------:|--:|---------:|--------:|--------:|--------:|------------:|------------:|-----------:|----:|\n|LagModel | 0.6253462|     0.6238692| 3.086485e+17|  423.4028|       0|  7| -32953.21| 61583.31| 61583.41| 61625.97| 3.107039e+17| 4.697631e+20|        1522|    7|\n\n\n:::\n\n```{.r .cell-code}\n# Residual diagnostics\nnyse_lag_model %>% \n  gg_tsresiduals() +\n  labs(title = \"Residual Diagnostics: NYSE Lag Model\")\n```\n\n::: {.cell-output-display}\n![](activity14_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n#### 3. Multivariate EDA: ggpairs Plot\n\n::: {.cell}\n\n```{.r .cell-code}\n# Prepare a multivariate dataset for ggpairs visualization\nnyse_multi <- nyse %>% \n  mutate(trend = row_number()) %>% \n  select(trend, volume, volume_lag1, volume_lag2) %>% \n  as_tibble()\n\nlibrary(GGally)\nggpairs(nyse_multi, \n        lower = list(continuous = wrap(\"smooth\", alpha = 0.3)),\n        title = \"Multivariate Relationships with Trend Component\")\n```\n\n::: {.cell-output-display}\n![](activity14_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n#### Lab Activity\n\n> **Task:** Experiment with including additional lags (e.g., lag 3 or lag 4) and higher order Fourier Harmonics in your model. Use ggpairs to visualize how these lagged variables relate to the current volume and discuss potential multicollinearity issues.\n\n\n**Solution:**\n\n1. **Model Comparison**:  \n\n::: {.cell}\n\n```{.r .cell-code}\nnyse <- nyse %>% \n  mutate(volume_lag3 = lag(volume, 3),\n         volume_lag4 = lag(volume, 4)) %>% \n  drop_na()\n\nnyse %>% \n  model(\n    Base = TSLM(volume ~ fourier(K = 2)),\n    Extended = TSLM(volume ~ fourier(K = 3) + volume_lag1 + volume_lag2),\n    Extended1 = TSLM(volume ~ fourier(K = 3) + volume_lag1 + volume_lag2 + volume_lag3 + volume_lag4)\n  ) %>% \n  glance() %>%  # Compare AIC/BIC\n  select(.model, adj_r_squared, AIC, AICc, BIC)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 Ã— 5\n  .model    adj_r_squared    AIC   AICc    BIC\n  <chr>             <dbl>  <dbl>  <dbl>  <dbl>\n1 Base            0.00484 62903. 62903. 62935.\n2 Extended        0.626   61413. 61413. 61467.\n3 Extended1       0.632   61392. 61392. 61456.\n```\n\n\n:::\n\n```{.r .cell-code}\n# Fit the better mode\nnyse_final <- nyse %>% \n  model(\n    BestModel = TSLM(volume ~ fourier(K = 3) + volume_lag1 + volume_lag2 + volume_lag3 + volume_lag4)\n  )\n  \nnyse_final %>% gg_tsresiduals()\n```\n\n::: {.cell-output-display}\n![](activity14_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\nnyse_final %>% \n  augment() %>% \n  ggplot(aes(x = .fitted, y = volume)) + \n  geom_hex() +  # Density-aware plotting\n  geom_abline(slope = 1) +\n  labs(title = \"Actual vs Fitted Values with Density Gradient\")\n```\n\n::: {.cell-output-display}\n![](activity14_files/figure-html/unnamed-chunk-6-2.png){width=672}\n:::\n:::\n\n\n\n\n\n",
    "supporting": [
      "activity14_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}